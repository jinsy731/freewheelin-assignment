# í•™ìŠµì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ

## í”„ë¡œì íŠ¸ ê°œìš”

í•™ìŠµì§€ ìƒì„±, ì¶œì œ, ì±„ì  ë° ë¶„ì„ì„ ìœ„í•œ ì¢…í•© ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ğŸ“‹ ì£¼ìš” ê¸°ëŠ¥

- **í•™ìŠµì§€ ê´€ë¦¬**: ë¬¸ì œ ì„ íƒ ë° í•™ìŠµì§€ ìƒì„±
- **ì¶œì œ ì‹œìŠ¤í…œ**: í•™ìƒë³„ í•™ìŠµì§€ ì¶œì œ
- **ìë™ ì±„ì **: ë‹µì•ˆ ì œì¶œ ì‹œ ì‹¤ì‹œê°„ ì±„ì 
- **í†µê³„ ë¶„ì„**: ë¬¸ì œë³„/í•™ìƒë³„ ì„±ê³¼ ë¶„ì„

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

- **Backend**: Spring Boot 3.5.3, Kotlin 1.9.25
- **Database**: H2 Database (ê°œë°œìš©)
- **Security**: Spring Security
- **Documentation**: Swagger/OpenAPI 3
- **Build Tool**: Gradle

## ğŸƒâ€â™‚ï¸ ì‹¤í–‰ ë°©ë²•

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

```bash
./gradlew bootRun
```

### 2. ì ‘ì† ì •ë³´

- **ì• í”Œë¦¬ì¼€ì´ì…˜**: http://localhost:8080
- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **H2 Console**: http://localhost:8080/h2-console
  - JDBC URL: `jdbc:h2:mem:pulleydb`
  - Username: `sa`
  - Password: (ë¹„ì›Œë‘ê¸°)

## ğŸ“š API ë¬¸ì„œ

### Swagger UI ì ‘ì†

ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„ http://localhost:8080/swagger-ui.html ì—ì„œ API ë¬¸ì„œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì£¼ìš” API ì—”ë“œí¬ì¸íŠ¸

#### ğŸ¯ í•™ìŠµì§€ ê´€ë¦¬ (`/piece`)

- `POST /piece` - í•™ìŠµì§€ ìƒì„± (ì„ ìƒë‹˜ ì „ìš©)
- `GET /piece/{pieceId}/problems` - í•™ìŠµì§€ ë¬¸ì œ ëª©ë¡ ì¡°íšŒ
- `PATCH /piece/{pieceId}/order` - ë¬¸ì œ ìˆœì„œ ìˆ˜ì • (ì„ ìƒë‹˜ ì „ìš©)
- `GET /piece/{pieceId}/analysis` - í•™ìŠµì§€ ë¶„ì„ (ì„ ìƒë‹˜ ì „ìš©)

#### ğŸ“ ì¶œì œ ë° ì±„ì  (`/piece/{pieceId}`)

- `POST /piece/{pieceId}` - í•™ìŠµì§€ ì¶œì œ (ì„ ìƒë‹˜ ì „ìš©)
- `PUT /piece/{pieceId}/score` - ë‹µì•ˆ ì œì¶œ ë° ìë™ ì±„ì 

#### ğŸ” ë¬¸ì œ ê´€ë¦¬ (`/problems`)

- `GET /problems` - ë¬¸ì œ ê²€ìƒ‰ (ì¡°ê±´ë³„ í•„í„°ë§)

### ì¸ì¦ ë°©ì‹

ëª¨ë“  APIëŠ” í—¤ë” ê¸°ë°˜ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.

í—¤ë”ì— `X-User-Id` ì™€ UserId ê°’ì„ ì…ë ¥í•˜ê³  ìš”ì²­í•©ë‹ˆë‹¤.

```bash
# ì˜ˆì‹œ ìš”ì²­
curl -H "Authorization: Bearer <your-jwt-token>" \
     -H "Content-Type: application/json" \
     http://localhost:8080/piece/1/problems
```

# í•™ìŠµì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ë¬¸ì„œ

## 1. ERD (Entity Relationship Diagram)

```mermaid
erDiagram
    pieces ||--o{ piece_problems : "contains"
    problems ||--o{ piece_problems : "included_in"
    pieces ||--o{ assignments : "assigned_to"
    assignments ||--o{ submissions : "submitted_for"
    problems ||--o{ submissions : "answered_in"
    pieces ||--o{ piece_problem_stats : "statistics_for"
    problems ||--o{ piece_problem_stats : "statistics_of"
    assignments ||--|| piece_student_stats : "student_stats"
    pieces ||--o{ piece_student_stats : "piece_stats"

    pieces {
        BIGINT id PK "í•™ìŠµì§€ ID"
        BIGINT teacher_id "ì„ ìƒë‹˜ ID"
        VARCHAR name "í•™ìŠµì§€ ì´ë¦„"
    }

    problems {
        BIGINT id PK "ë¬¸ì œ ID"
        TEXT answer "ì •ë‹µ"
        VARCHAR unit_code "ìœ í˜• ì½”ë“œ"
        INT problem_level "ë‚œì´ë„(1-5)"
        VARCHAR problem_type "ë¬¸ì œ ìœ í˜•"
    }

    piece_problems {
        BIGINT id PK "ë§¤í•‘ ID"
        BIGINT piece_id FK "í•™ìŠµì§€ ID"
        BIGINT problem_id FK "ë¬¸ì œ ID"
        DOUBLE position "ìˆœì„œ ìœ„ì¹˜"
    }

    assignments {
        BIGINT id PK "ì¶œì œ ID"
        BIGINT piece_id FK "í•™ìŠµì§€ ID"
        BIGINT student_id "í•™ìƒ ID"
        TIMESTAMP assigned_at "ì¶œì œ ì‹œê°„"
        TIMESTAMP submitted_at "ì œì¶œ ì‹œê°„"
        NUMERIC correctness_rate "ì •ë‹µë¥ "
    }

    submissions {
        BIGINT id PK "ì œì¶œ ID"
        BIGINT assignment_id FK "ì¶œì œ ID"
        BIGINT problem_id FK "ë¬¸ì œ ID"
        TEXT answer "ì œì¶œ ë‹µì•ˆ"
        BOOLEAN is_correct "ì •ë‹µ ì—¬ë¶€"
    }

    piece_problem_stats {
        BIGINT id PK "í†µê³„ ID"
        BIGINT piece_id FK "í•™ìŠµì§€ ID"
        BIGINT problem_id FK "ë¬¸ì œ ID"
        INT total_count "ì´ ì œì¶œ ìˆ˜"
        INT correct_count "ì •ë‹µ ìˆ˜"
        NUMERIC correctness_rate "ì •ë‹µë¥ "
    }

    piece_student_stats {
        BIGINT id PK "í†µê³„ ID"
        BIGINT assignment_id FK "ì¶œì œ ID"
        BIGINT piece_id FK "í•™ìŠµì§€ ID"
        BIGINT student_id "í•™ìƒ ID"
        INT total_count "ì´ ë¬¸ì œ ìˆ˜"
        INT correct_count "ì •ë‹µ ìˆ˜"
        NUMERIC correctness_rate "ì •ë‹µë¥ "
    }
```

## 2. í…Œì´ë¸”ë³„ ì„¤ê³„ ê·¼ê±° ë° ë¶„ì„

### 2.1 pieces (í•™ìŠµì§€) í…Œì´ë¸”

```sql
CREATE TABLE pieces (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    teacher_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL
);
CREATE INDEX idx_teacher_id ON pieces (teacher_id);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **ë°ì´í„° íƒ€ì… ì„ ì •**:

   - `id`: `BIGINT` - ëŒ€ìš©ëŸ‰ ë°ì´í„° í™•ì¥ì„± ê³ ë ¤ (ìµœëŒ€ 9,223,372,036,854,775,807ê°œ)
   - `teacher_id`: `BIGINT` - ì‚¬ìš©ì í…Œì´ë¸”ê³¼ì˜ ì¼ê´€ì„± ìœ ì§€
   - `name`: `VARCHAR(100)` - í•œê¸€ ê¸°ì¤€ 50ì, UTF-8 ì¸ì½”ë”© ê³ ë ¤í•˜ì—¬ ì¶©ë¶„í•œ ê¸¸ì´

2. **ì¸ë±ìŠ¤ ì„¤ê³„**:
   - `idx_teacher_id`: ì„ ìƒë‹˜ë³„ í•™ìŠµì§€ ì¡°íšŒ ìµœì í™”
   - ì¹´ë””ë„ë¦¬í‹°ê°€ ë†’ì•„ ì¸ë±ìŠ¤ íš¨ê³¼ ìš°ìˆ˜

**ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­**:

- ì„ ìƒë‹˜ë‹¹ í‰ê·  100ê°œ í•™ìŠµì§€ ê°€ì • ì‹œ, ì¸ë±ìŠ¤ ìŠ¤ìº”ìœ¼ë¡œ O(log n) ì„±ëŠ¥ ë³´ì¥

### 2.2 problems (ë¬¸ì œ) í…Œì´ë¸”

```sql
CREATE TABLE problems (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    answer TEXT NOT NULL,
    unit_code VARCHAR(10) NOT NULL,
    problem_level INT NOT NULL,
    problem_type VARCHAR(255) NOT NULL
);
CREATE INDEX idx_unit_code ON problems (unit_code);
CREATE INDEX idx_level ON problems (problem_level);
CREATE INDEX idx_problem_type ON problems (problem_type);
CREATE INDEX idx_unit_code_level_type ON problems (unit_code, problem_level, problem_type);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **ë°ì´í„° íƒ€ì… ì„ ì •**:

   - `answer`: `TEXT` - ê¸´ ë‹µì•ˆ ì§€ì› (ìˆ˜í•™ ê³µì‹, ê¸´ ì„œìˆ í˜• ë‹µì•ˆ)
   - `unit_code`: `VARCHAR(10)` - 'uc1234' í˜•íƒœì˜ ì½”ë“œ ì²´ê³„
   - `problem_level`: `INT` - 1~5 ë²”ìœ„, í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„± ê³ ë ¤
   - `problem_type`: `VARCHAR(255)` - ENUM ëŒ€ì‹  VARCHAR ì‚¬ìš©ìœ¼ë¡œ ìœ ì—°ì„± í™•ë³´

2. **ì¸ë±ìŠ¤ ì „ëµ**:
   - **ë³µí•© ì¸ë±ìŠ¤ ìš°ì„ **: `idx_unit_code_level_type`ê°€ ëŒ€ë¶€ë¶„ì˜ ì¿¼ë¦¬ ì»¤ë²„
   - **ë‹¨ì¼ ì¸ë±ìŠ¤**: ê°œë³„ ì¡°ê±´ ê²€ìƒ‰ ì‹œ ì‚¬ìš©
   - **ì¸ë±ìŠ¤ ìˆœì„œ**: ì¹´ë””ë„ë¦¬í‹° ë†’ì€ ìˆœ (unit_code > problem_level > problem_type)

**ì¿¼ë¦¬ ìµœì í™” ë¶„ì„**:

```sql
-- ê°€ì¥ ë¹ˆë²ˆí•œ ì¿¼ë¦¬ íŒ¨í„´
SELECT * FROM problems
WHERE unit_code IN ('MATH_01', 'KOR_01')
  AND problem_level IN (1,2,3)
  AND problem_type = 'SELECTION'
ORDER BY unit_code, problem_level;
-- â†’ idx_unit_code_level_type ì¸ë±ìŠ¤ë¡œ ìµœì í™”
```

### 2.3 piece_problems (í•™ìŠµì§€-ë¬¸ì œ ë§¤í•‘) í…Œì´ë¸”

```sql
CREATE TABLE piece_problems (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    piece_id BIGINT NOT NULL,
    problem_id BIGINT NOT NULL,
    position DOUBLE NOT NULL,
    CONSTRAINT uk_piece_problem UNIQUE (piece_id, problem_id)
);
CREATE INDEX idx_piece_id ON piece_problems (piece_id);
CREATE INDEX idx_piece_position ON piece_problems (piece_id, position);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **ì •ê·œí™” ìˆ˜ì¤€**:

   - ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ì¤‘ê°„ í…Œì´ë¸”ë¡œ í•´ê²°
   - ìˆœì„œ ì •ë³´(`position`)ë¥¼ ì¶”ê°€ ì†ì„±ìœ¼ë¡œ í¬í•¨ (ë¬¸ì œ ìˆœì„œ ê´€ë¦¬)

2. **ìˆœì„œ ê´€ë¦¬ ì „ëµ**:

   - **í˜„ì¬**: `DOUBLE` íƒ€ì…ìœ¼ë¡œ ì¤‘ê°„ê°’ ì‚½ì… ë°©ì‹
   - **ê°œì„  ë°©í–¥**: `VARCHAR` íƒ€ì…ìœ¼ë¡œ ë¬¸ìì—´ ê¸°ë°˜ Rank ì‹œìŠ¤í…œ

3. **ì œì•½ì¡°ê±´**:
   - `uk_piece_problem`: ë™ì¼ í•™ìŠµì§€ì— ê°™ì€ ë¬¸ì œ ì¤‘ë³µ ë°©ì§€
   - ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì„ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ê°•ì œ

**ì„±ëŠ¥ ìµœì í™”**:

```sql
-- ìˆœì„œ ë³€ê²½ ìµœì í™”ë¥¼ ìœ„í•œ ê°œì„ ì•ˆ
ALTER TABLE piece_problems MODIFY COLUMN position VARCHAR(50);

-- ë¬¸ìì—´ ê¸°ë°˜ ìˆœì„œ ê´€ë¦¬ ì˜ˆì‹œ
-- ê¸°ì¡´: 1.0, 2.0, 3.0 â†’ ì¤‘ê°„ ì‚½ì… ì‹œ 1.5 (ì •ë°€ë„ í•œê³„)
-- ê°œì„ : "a", "b", "c" â†’ ì¤‘ê°„ ì‚½ì… ì‹œ "am" (ë¬´í•œ í™•ì¥)
```

### 2.4 assignments (ì¶œì œ) í…Œì´ë¸”

```sql
CREATE TABLE assignments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    piece_id BIGINT NOT NULL,
    student_id BIGINT NOT NULL,
    assigned_at TIMESTAMP NOT NULL,
    submitted_at TIMESTAMP,
    correctness_rate NUMERIC(5, 2),
    CONSTRAINT uk_assignments_piece_student UNIQUE (piece_id, student_id)
);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **ì •ê·œí™” ìˆ˜ì¤€**:

   - í•™ìŠµì§€ì™€ í•™ìƒì˜ ë‹¤ëŒ€ë‹¤ ê´€ê³„ í•´ê²°
   - ì¶œì œ ì‹œì ê³¼ ì œì¶œ ì‹œì  ë¶„ë¦¬ ì¶”ì 

2. **ë°ì´í„° íƒ€ì… ì„ ì •**:

   - `assigned_at`: `TIMESTAMP` - ì¶œì œ ì‹œì  ì •í™•í•œ ê¸°ë¡
   - `submitted_at`: `TIMESTAMP NULL` - ë¯¸ì œì¶œ ìƒíƒœ í—ˆìš©
   - `correctness_rate`: `NUMERIC(5,2)` - 99.99% ê¹Œì§€ ì •ë°€ë„ ë³´ì¥

3. **ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ë°˜ì˜**:
   - `uk_assignments_piece_student`: ë™ì¼ í•™ìŠµì§€ ì¤‘ë³µ ì¶œì œ ë°©ì§€

**ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­**:

- í•™ìƒë³„ ì¶œì œ ì´ë ¥ ì¡°íšŒ: `student_id` ì¸ë±ìŠ¤ í•„ìš”
- í•™ìŠµì§€ë³„ ì¶œì œ í˜„í™© ì¡°íšŒ: `piece_id` ì¸ë±ìŠ¤ í•„ìš”

### 2.5 submissions (ì œì¶œ) í…Œì´ë¸”

```sql
CREATE TABLE submissions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    assignment_id BIGINT NOT NULL,
    problem_id BIGINT NOT NULL,
    answer TEXT NOT NULL,
    is_correct BOOLEAN NOT NULL,
    CONSTRAINT uk_submissions_assignment_problem UNIQUE (assignment_id, problem_id)
);
CREATE INDEX idx_assignment_id ON submissions (assignment_id);
CREATE INDEX idx_problem_id ON submissions (problem_id);
CREATE INDEX idx_assignment_problem ON submissions (assignment_id, problem_id);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **ì •ê·œí™” ìˆ˜ì¤€**:

   - ì¶œì œì™€ ë¬¸ì œì˜ ë‹¤ëŒ€ë‹¤ ê´€ê³„ í•´ê²°
   - ì œì¶œ ë‹µì•ˆê³¼ ì±„ì  ê²°ê³¼ ë¶„ë¦¬ ì €ì¥

2. **ë°ì´í„° íƒ€ì… ì„ ì •**:

   - `answer`: `TEXT` - ê¸´ ì„œìˆ í˜• ë‹µì•ˆ ì§€ì›
   - `is_correct`: `BOOLEAN` - ì •ë‹µ/ì˜¤ë‹µ êµ¬ë¶„

3. **ì œì•½ì¡°ê±´**:
   - `uk_submissions_assignment_problem`: ë™ì¼ ë¬¸ì œ ì¤‘ë³µ ì œì¶œ ë°©ì§€
   - í•œ ë²ˆ ì œì¶œí•œ ë‹µì•ˆì€ ìˆ˜ì • ë¶ˆê°€ ì •ì±… ë°˜ì˜

**ì¿¼ë¦¬ íŒ¨í„´ ë¶„ì„**:

```sql
-- í•™ìƒë³„ ì œì¶œ í˜„í™© ì¡°íšŒ
SELECT * FROM submissions WHERE assignment_id = ?;
-- â†’ idx_assignment_id ì‚¬ìš©

-- ë¬¸ì œë³„ ì •ë‹µë¥  ë¶„ì„
SELECT problem_id, AVG(CASE WHEN is_correct THEN 1.0 ELSE 0.0 END)
FROM submissions WHERE assignment_id IN (SELECT id FROM assignments WHERE piece_id = ?)
GROUP BY problem_id;
-- â†’ idx_assignment_problem ë³µí•© ì¸ë±ìŠ¤ í™œìš©
```

### 2.6 í†µê³„ í…Œì´ë¸” ì„¤ê³„

#### 2.6.1 piece_problem_stats (ë¬¸ì œë³„ í†µê³„)

```sql
CREATE TABLE piece_problem_stats (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    piece_id BIGINT NOT NULL,
    problem_id BIGINT NOT NULL,
    total_count INT NOT NULL,
    correct_count INT NOT NULL,
    correctness_rate NUMERIC(5, 2) NOT NULL,
    CONSTRAINT uk_piece_problem_stats_piece_problem UNIQUE (piece_id, problem_id)
);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **ë¹„ì •ê·œí™” ì„ íƒ ì´ìœ **:

   - ì‹¤ì‹œê°„ ì§‘ê³„ ì¿¼ë¦¬ì˜ ì„±ëŠ¥ ë¬¸ì œ í•´ê²°
   - í•™ìƒ 100ëª… Ã— ë¬¸ì œ 50ê°œ = 5,000ê°œ ë ˆì½”ë“œ ì§‘ê³„ â†’ 50ê°œ ë ˆì½”ë“œ ì¡°íšŒë¡œ ìµœì í™”

2. **ì¤‘ë³µ ë°ì´í„° í—ˆìš©**:

   - `correctness_rate`ëŠ” `correct_count/total_count`ë¡œ ê³„ì‚° ê°€ëŠ¥í•˜ì§€ë§Œ ì„±ëŠ¥ì„ ìœ„í•´ ì €ì¥
   - ì—…ë°ì´íŠ¸ ì‹œ ì¼ê´€ì„± ìœ ì§€ í•„ìš”

3. **ë™ì‹œì„± ê³ ë ¤**:
   - ì—¬ëŸ¬ í•™ìƒì˜ ë™ì‹œ ì œì¶œë¡œ ì¸í•œ ê²½í•© ìƒí™© ë°œìƒ ê°€ëŠ¥
   - ë¹„ê´€ì  ë½ ë˜ëŠ” ì›ìì  ì—…ë°ì´íŠ¸ í•„ìš”

#### 2.6.2 piece_student_stats (í•™ìƒë³„ í†µê³„)

```sql
CREATE TABLE piece_student_stats (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    assignment_id BIGINT NOT NULL UNIQUE,
    piece_id BIGINT NOT NULL,
    student_id BIGINT NOT NULL,
    total_count INT NOT NULL,
    correct_count INT NOT NULL,
    correctness_rate NUMERIC(5, 2) NOT NULL,
    CONSTRAINT uk_piece_student_stats_piece_student UNIQUE (piece_id, student_id)
);
```

**ì„¤ê³„ ê·¼ê±°**:

1. **assignment_id ì°¸ì¡°**:

   - 1:1 ê´€ê³„ë¡œ ì •ê·œí™” ìœ ì§€
   - ì¶œì œ ì •ë³´ì™€ í†µê³„ ì •ë³´ ì—°ê²°

2. **ì´ì¤‘ UNIQUE ì œì•½ì¡°ê±´**:
   - `assignment_id`: ì¶œì œë‹¹ í•˜ë‚˜ì˜ í†µê³„
   - `(piece_id, student_id)`: í•™ìŠµì§€-í•™ìƒ ì¡°í•©ì˜ ìœ ì¼ì„±

## 3. ì¸ë±ìŠ¤ ìµœì í™” ì „ëµ

### 3.1 í˜„ì¬ ì¸ë±ìŠ¤ ë¶„ì„

**íš¨ìœ¨ì ì¸ ì¸ë±ìŠ¤**:

- `problems.idx_unit_code_level_type`: ë³µí•© ì¡°ê±´ ì¿¼ë¦¬ ìµœì í™”
- `piece_problems.idx_piece_position`: ìˆœì„œ ì •ë ¬ ì¿¼ë¦¬ ìµœì í™”

**ê°œì„  í•„ìš”í•œ ì¸ë±ìŠ¤**:

```sql
-- ì¤‘ë³µ ì¸ë±ìŠ¤ ì œê±° (ë³µí•© ì¸ë±ìŠ¤ê°€ ë‹¨ì¼ ì¸ë±ìŠ¤ ì—­í•  í¬í•¨)
DROP INDEX idx_unit_code ON problems;
DROP INDEX idx_level ON problems;
DROP INDEX idx_problem_type ON problems;

-- í•„ìš”í•œ ì¸ë±ìŠ¤ ì¶”ê°€
CREATE INDEX idx_assignments_student_id ON assignments (student_id);
CREATE INDEX idx_submissions_problem_correct ON submissions (problem_id, is_correct);
```

---

## ì„±ëŠ¥ ë° ë¹„ìš© ìµœì í™”

### 1. ì´ë¯¸ êµ¬í˜„ëœ ìµœì í™” ì‚¬í•­

#### 1.1 ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ìµœì í™”

**êµ¬í˜„ëœ ì¸ë±ìŠ¤**:

```sql
-- problems í…Œì´ë¸” ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_unit_code_level_type ON problems (unit_code, problem_level, problem_type);

-- piece_problems í…Œì´ë¸” ìˆœì„œ ì •ë ¬ ì¸ë±ìŠ¤
CREATE INDEX idx_piece_position ON piece_problems (piece_id, position);

-- ì‚¬ìš©ì í…Œì´ë¸” ê³ ìœ  ì¸ë±ìŠ¤
CREATE UNIQUE INDEX idx_users_username ON users (username);
CREATE UNIQUE INDEX idx_users_email ON users (email);
```

**ì„±ëŠ¥ íš¨ê³¼**:

- ë¬¸ì œ ì¡°íšŒ ì‹œ ë³µí•© ì¡°ê±´ í•„í„°ë§ ì„±ëŠ¥ í–¥ìƒ
- í•™ìŠµì§€ ë¬¸ì œ ì •ë ¬ ì„±ëŠ¥ í–¥ìƒ

#### 1.2 í†µê³„ í…Œì´ë¸” ì‚¬ì „ êµ¬ì¶•

**êµ¬í˜„ëœ í†µê³„ í…Œì´ë¸”**:

```kotlin
// ë¬¸ì œë³„ í†µê³„ í…Œì´ë¸”
data class PieceProblemStat(
    val pieceId: PieceId,
    val problemId: ProblemId,
    val totalCount: Int,
    val correctCount: Int,
    val correctnessRate: CorrectnessRate
)

// í•™ìƒë³„ í†µê³„ í…Œì´ë¸”
data class PieceStudentStat(
    val assignmentId: AssignmentId,
    val pieceId: PieceId,
    val studentId: StudentId,
    val totalCount: Int,
    val correctCount: Int,
    val correctnessRate: CorrectnessRate
)
```

**ì„±ëŠ¥ íš¨ê³¼**:

- í†µê³„ ì¡°íšŒ ì‹œ ì§‘ê³„ ì—°ì‚° ì œê±°ë¡œ ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•
- ì´ë²¤íŠ¸ ê¸°ë°˜ ì—…ë°ì´íŠ¸ë¡œ ì‘ë‹µ ì§€ì—° ê°ì†Œ DB ë¶€í•˜ ê°ì†Œ

#### 1.3 ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬

**êµ¬í˜„ëœ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ**:

```kotlin
// ì´ë²¤íŠ¸ ì²˜ë¦¬
@Component
class StatisticsEventHandler {
    @EventListener
    fun handleSubmissionGraded(event: SubmissionGradedEvent) {
        statisticsUpdateService.updateStatistics(event)
    }
}
```

**ì„±ëŠ¥ íš¨ê³¼**:

- ì±„ì  API ì‘ë‹µ ì‹œê°„ ë‹¨ì¶• (í†µê³„ ì—…ë°ì´íŠ¸ ë¹„ë™ê¸° ë¶„ë¦¬)
- ì‹œìŠ¤í…œ í™•ì¥ì„± í–¥ìƒ

#### 1.4 JPA ìµœì í™” ì„¤ì •

**ì ìš©ëœ ì„¤ì •**:

```yaml
# application.yml
spring:
  jpa:
    properties:
      hibernate:
        jdbc:
          batch_size: 20 # ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”
    open-in-view: false # ë¶ˆí•„ìš”í•œ ì§€ì—° ë¡œë”© ë°©ì§€
```

### 2. ì¶”ê°€ ê°œì„  ë°©ì•ˆ

#### 2.1 ìºì‹± ì „ëµ ë„ì…

**Redis ê¸°ë°˜ ìºì‹±**:

```kotlin
@Service
class ProblemService {
    @Cacheable(
        value = ["problems"],
        key = "#unitCodes?.toString() + '_' + #level + '_' + #problemType"
    )
    fun searchProblems(
        unitCodes: List<String>?,
        level: String?,
        problemType: String?
    ): List<Problem> {
        return problemRepository.findByConditions(unitCodes, level, problemType)
    }
}

@CacheEvict(value = ["problems"], allEntries = true)
fun clearProblemCache() {
    // ë¬¸ì œ ë°ì´í„° ë³€ê²½ ì‹œ ìºì‹œ ë¬´íš¨í™”
}
```

**ì˜ˆìƒ íš¨ê³¼**:

- ë°˜ë³µ ì¡°íšŒ ì‹œ ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•
- DB ë¶€í•˜ ê°ì†Œ

#### 2.2 ì»¤ë„¥ì…˜ í’€ ìµœì í™”

**HikariCP ì„¤ì • ê°œì„ **:

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 20000
      idle-timeout: 300000
      max-lifetime: 1200000
      leak-detection-threshold: 60000
```

**ì˜ˆìƒ íš¨ê³¼**:

- ë™ì‹œ ì ‘ì†ì ì¦ê°€ ì‹œ DB ì—°ê²° ëŒ€ê¸° ì‹œê°„ ê°ì†Œ

#### 2.3 í˜ì´ì§• ì²˜ë¦¬ ë„ì…

**ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ìµœì í™”**:

```kotlin
@GetMapping("/problems")
fun getProblems(
    @RequestParam(defaultValue = "0") page: Int,
    @RequestParam(defaultValue = "20") size: Int,
    @RequestParam unitCodes: List<String>?
): Page<ProblemResponse> {
    val pageable = PageRequest.of(page, size)
    return problemService.findProblems(pageable, unitCodes)
        .map { ProblemResponse.from(it) }
}
```

**ì˜ˆìƒ íš¨ê³¼**:

- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œ
- ì´ˆê¸° ë¡œë”© ì‹œê°„ ë‹¨ì¶•

---

## ğŸ”„ í•™ìŠµì§€ ìˆœì„œ ë³€ê²½ ë¡œì§ ìµœì í™”

### 1. í˜„ì¬ êµ¬í˜„ ë° ë¬¸ì œì 

#### 1.1 í˜„ì¬ Double ê¸°ë°˜ Position ì‹œìŠ¤í…œ

**í˜„ì¬ êµ¬í˜„**:

```kotlin
// Position.kt - ë¶€ë™ì†Œìˆ˜ì  ê¸°ë°˜ ì¤‘ê°„ê°’ ê³„ì‚°
companion object {
    fun between(before: Position?, after: Position?): Position {
        return when {
            before == null && after == null -> Position(1.0)
            before == null -> Position(after!!.value / 2.0)
            after == null -> Position(before.value + 1.0)
            else -> Position((before.value + after.value) / 2.0)  // ì •ë°€ë„ ì†ì‹¤ ì§€ì 
        }
    }
}
```

**í˜„ì¬ ìˆœì„œ ë³€ê²½ ì„œë¹„ìŠ¤**:

```kotlin
// PieceOrderUpdateService.kt
fun updateProblemOrder(command: ProblemOrderUpdateCommand): ProblemOrderUpdateResult {
    val updatedProblem = problemToMove.moveTo(prevProblem, nextProblem)
    pieceProblemRepository.save(updatedProblem)
    return ProblemOrderUpdateResult(/* ... */)
}
```

#### 1.2 í˜„ì¬ ì‹œìŠ¤í…œì˜ ë¬¸ì œì 

**1. ì •ë°€ë„ í•œê³„**:

- ë°˜ë³µì ì¸ ì¤‘ê°„ê°’ ê³„ì‚°ìœ¼ë¡œ `1.0` â†’ `1.5` â†’ `1.25` â†’ `1.125` â†’ ...
- ë¶€ë™ì†Œìˆ˜ì  ì •ë°€ë„ í•œê³„ì— ë„ë‹¬í•˜ë©´ ìˆœì„œ ë³€ê²½ ë¶ˆê°€

**2. ë¦¬ë°¸ëŸ°ì‹± ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¬**:

- ì •ë°€ë„ í•œê³„ ë„ë‹¬ ì‹œ ìë™ ë¦¬ë°¸ëŸ°ì‹± ë¡œì§ ì—†ìŒ
- ìˆ˜ë™ ê°œì… í•„ìš”

**3. í´ë¼ì´ì–¸íŠ¸-ì„œë²„ í†µì‹  ë¹„íš¨ìœ¨**:

- í˜„ì¬ëŠ” ìµœì í™”ë˜ì–´ ìˆì§€ë§Œ, ì •ë°€ë„ ë¬¸ì œë¡œ ì¸í•œ ì ì¬ì  ì´ìŠˆ

### 2. ê¶Œì¥ ê°œì„ ë°©ì•ˆ

#### 2.1 ë¬¸ìì—´ ê¸°ë°˜ Rank ì‹œìŠ¤í…œ ë„ì…

**ê°œì„ ëœ Position êµ¬ì¡°**:

```kotlin
// ê¸°ì¡´ Double íƒ€ì…ì„ String íƒ€ì…ìœ¼ë¡œ ë³€ê²½
data class Position(val value: String) {

    companion object {
        private val CHARS = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"

        fun between(before: Position?, after: Position?): Position {
            return when {
                before == null && after == null -> Position("n") // ì¤‘ê°„ê°’
                before == null -> Position(generateBefore(after!!.value))
                after == null -> Position(generateAfter(before!!.value))
                else -> Position(generateMiddle(before.value, after.value))
            }
        }

        private fun generateMiddle(prev: String, next: String): String {
            // Base62 ê¸°ë°˜ ì¤‘ê°„ê°’ ê³„ì‚° - ë¬´í•œ í™•ì¥ ê°€ëŠ¥
            val prevChars = prev.toCharArray()
            val nextChars = next.toCharArray()

            // ë‘ ë¬¸ìì—´ ì‚¬ì´ì˜ ì‚¬ì „ìˆœ ì¤‘ê°„ê°’ ìƒì„±
            return calculateLexicographicMiddle(prevChars, nextChars)
        }
    }
}
```

---

## ì ì¬ì  ìœ„í—˜ìš”ì†Œ ë° í•´ê²°ë°©ì•ˆ

#### 1.í†µê³„ í…Œì´ë¸” ë™ì‹œì„± ë¬¸ì œ

**ìœ„í—˜ìš”ì†Œ**:

- `piece_problem_stats` í…Œì´ë¸”ì´ ì—¬ëŸ¬ í•™ìƒì˜ ë™ì‹œ ì œì¶œì— ì˜í•´ ì—…ë°ì´íŠ¸ë  ë•Œ ë°ì´í„° ë¶ˆì¼ì¹˜ ë°œìƒ ê°€ëŠ¥
- Race Conditionìœ¼ë¡œ ì¸í•œ í†µê³„ ë°ì´í„° ì†ì‹¤

**í˜„ì¬ ì½”ë“œì˜ ë¬¸ì œì **:

```kotlin
// StatisticsUpdateService.kt - ë™ì‹œì„± ì´ìŠˆ ë°œìƒ ì§€ì 
val existingStat = pieceProblemStatRepository.findByPieceIdAndProblemId(event.pieceId, problemId)
val updatedStat = if (existingStat != null) {
    // ê¸°ì¡´ í†µê³„ì— ì¦ë¶„ ì¶”ê°€ - ë™ì‹œì„± ë¬¸ì œ ë°œìƒ
    existingStat.update(
        existingStat.totalCount + problemStats.totalCount,
        existingStat.correctCount + problemStats.correctCount
    )
}
```

**í•´ê²°ë°©ì•ˆ**:

1. **ë¹„ê´€ì  ë½ (Pessimistic Lock) ì ìš©**

```kotlin
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM PieceProblemStatJpaEntity p WHERE p.pieceId = :pieceId AND p.problemId = :problemId")
fun findByPieceIdAndProblemIdForUpdate(pieceId: Long, problemId: Long): PieceProblemStatJpaEntity?
```

2. **ì›ìì  ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ ì‚¬ìš©**

```kotlin
@Modifying
@Query("""
    UPDATE PieceProblemStatJpaEntity p
    SET p.totalCount = p.totalCount + :increment,
        p.correctCount = p.correctCount + :correctIncrement,
        p.correctnessRate = (p.correctCount + :correctIncrement) / (p.totalCount + :increment)
    WHERE p.pieceId = :pieceId AND p.problemId = :problemId
""")
fun incrementCounts(pieceId: Long, problemId: Long, increment: Int, correctIncrement: Int)
```

#### 2. N+1 ì¿¼ë¦¬ ë¬¸ì œ

**ìœ„í—˜ìš”ì†Œ**:

- `ProblemSearchService`ì—ì„œ ê° ë‚œì´ë„ë³„ë¡œ ë³„ë„ ì¿¼ë¦¬ ì‹¤í–‰
- ëŒ€ëŸ‰ ë°ì´í„° ì¡°íšŒ ì‹œ ì„±ëŠ¥ ì €í•˜

**í˜„ì¬ ë¬¸ì œ ì½”ë“œ**:

```kotlin
// ProblemSearchService.kt - ê° ë‚œì´ë„ë³„ ê°œë³„ ì¿¼ë¦¬
val lowProblems = problemRepository.findByConditions(
    unitCodes = query.unitCodeList,
    problemType = domainProblemType,
    levels = Level.LOW.levels,
    limit = distributionPlan.lowCount
)
val middleProblems = problemRepository.findByConditions(...) // ì¶”ê°€ ì¿¼ë¦¬
val highProblems = problemRepository.findByConditions(...)   // ì¶”ê°€ ì¿¼ë¦¬
```

**í•´ê²°ë°©ì•ˆ**:

1. **ë‹¨ì¼ ì¿¼ë¦¬ë¡œ í†µí•©**

```kotlin
@Query("""
    SELECT p FROM ProblemJpaEntity p
    WHERE p.unitCode IN :unitCodes
    AND (:problemType IS NULL OR p.problemType = :problemType)
    ORDER BY p.level ASC, FUNCTION('RAND')
""")
fun findAllByConditionsWithRandomOrder(
    unitCodes: List<String>,
    problemType: ProblemType?
): List<ProblemJpaEntity>
```

2. **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ë¶„ë°°**

```kotlin
fun searchProblems(query: ProblemSearchQuery): ProblemSearchResult {
    val allProblems = problemRepository.findAllByConditionsWithRandomOrder(
        query.unitCodeList, query.problemType
    )

    return LevelDistribution.fromLevel(query.level)
        .distribute(allProblems, query.totalCount)
}
```

---
